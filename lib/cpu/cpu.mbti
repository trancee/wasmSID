package "trancee/wasmSID/lib/cpu"

import(
  "trancee/wasmSID/lib/types"
)

// Values
const CPU_MEM_END : Int = 0xFFFF

const CPU_MEM_SIZE : Int = 0xFFFF

const CPU_MEM_START : Int = 0x0000

const IRQ : Int = 0xFFFE

const NMI : Int = 0xFFFA

const RESET : Int = 0xFFFC

fn a(CPU) -> @types.UInt8

fn clear_flags(CPU) -> Unit

fn clear_registers(CPU) -> Unit

fn dump(CPU, addr~ : @types.UInt16 = .., cols~ : Int = .., rows~ : Int = ..) -> Unit

fn get_flags(CPU) -> Flags

fn get_registers(CPU) -> Registers

fn has_interrupt(CPU) -> Bool

fn interrupts(CPU) -> Bool

fn irq(CPU, pc? : @types.UInt16) -> Unit

fn load(CPU, @types.UInt16, Bytes, length~ : Int = .., offset~ : Int = .., has_load_address~ : Bool = ..) -> @types.UInt16

fn nmi(CPU, pc? : @types.UInt16) -> Unit

fn pc(CPU) -> @types.UInt16

fn push(CPU, @types.UInt8, dummy~ : Bool = ..) -> Unit

fn push16(CPU, @types.UInt16) -> Unit

fn read(CPU, @types.UInt16, dummy~ : Bool = ..) -> @types.UInt8

fn read16(CPU, @types.UInt16, dummy~ : Bool = ..) -> @types.UInt16

fn register(CPU, Register, @types.UInt8) -> Unit

fn set_debug(CPU, Bool) -> Unit

fn set_flags(CPU, @types.UInt8) -> Unit

fn set_irq(CPU, state~ : Bool = ..) -> Unit

fn set_nmi(CPU, state~ : Bool = ..) -> Unit

fn set_read(CPU, (@types.UInt16, Bool) -> @types.UInt8) -> Unit

fn set_write(CPU, (@types.UInt16, @types.UInt8, Bool) -> Unit) -> Unit

fn step(CPU) -> Int

fn trap(CPU, @types.UInt16, (CPU) -> Unit) -> Unit

fn write(CPU, @types.UInt16, @types.UInt8, dummy~ : Bool = ..) -> Unit

fn write16(CPU, @types.UInt16, @types.UInt16, dummy~ : Bool = ..) -> Unit

// Types and methods
pub struct CPU {
  mem : FixedArray[@types.UInt8]
  mut read : ((@types.UInt16, Bool) -> @types.UInt8)?
  mut write : ((@types.UInt16, @types.UInt8, Bool) -> Unit)?
  mut cycles : Int
  mut pc : @types.UInt16
  registers : Registers
  flags : Flags
  decimal_mode : Bool
  mut nmi : Bool
  mut irq : Bool
  traps : Array[Trap]
  mut debug : Bool
}
impl CPU {
  a(Self) -> @types.UInt8
  clear_flags(Self) -> Unit
  clear_interrupt(Self) -> Unit
  clear_registers(Self) -> Unit
  dump(Self, addr~ : @types.UInt16 = .., cols~ : Int = .., rows~ : Int = ..) -> Unit
  get_flags(Self) -> Flags
  get_registers(Self) -> Registers
  has_interrupt(Self) -> Bool
  interrupts(Self) -> Bool
  irq(Self, pc? : @types.UInt16) -> Unit
  load(Self, @types.UInt16, Bytes, length~ : Int = .., offset~ : Int = .., has_load_address~ : Bool = ..) -> @types.UInt16
  new(pc~ : @types.UInt16 = .., address? : @types.UInt16, data~ : Bytes = .., length~ : Int = .., offset~ : Int = .., decimal_mode~ : Bool = .., debug~ : Bool = ..) -> Self
  nmi(Self, pc? : @types.UInt16) -> Unit
  pc(Self) -> @types.UInt16
  push(Self, @types.UInt8, dummy~ : Bool = ..) -> Unit
  push16(Self, @types.UInt16) -> Unit
  read(Self, @types.UInt16, dummy~ : Bool = ..) -> @types.UInt8
  read16(Self, @types.UInt16, dummy~ : Bool = ..) -> @types.UInt16
  register(Self, Register, @types.UInt8) -> Unit
  reset(Self, pc? : @types.UInt16) -> Unit
  set_debug(Self, Bool) -> Unit
  set_flags(Self, @types.UInt8) -> Unit
  set_interrupt(Self) -> Unit
  set_irq(Self, state~ : Bool = ..) -> Unit
  set_nmi(Self, state~ : Bool = ..) -> Unit
  set_read(Self, (@types.UInt16, Bool) -> @types.UInt8) -> Unit
  set_write(Self, (@types.UInt16, @types.UInt8, Bool) -> Unit) -> Unit
  step(Self) -> Int
  trap(Self, @types.UInt16, (Self) -> Unit) -> Unit
  write(Self, @types.UInt16, @types.UInt8, dummy~ : Bool = ..) -> Unit
  write16(Self, @types.UInt16, @types.UInt16, dummy~ : Bool = ..) -> Unit
}

pub(all) enum Flag {
  C
  Z
  I
  D
  B
  U
  V
  N
}
impl Flag {
  lor(Self, Self) -> Int
}
impl Eq for Flag

type Flags
impl Flags {
  get(Self) -> @types.UInt8
  set(Self, @types.UInt8) -> @types.UInt8
  set_interrupt(Self) -> Unit
}
impl Eq for Flags
impl Show for Flags

pub(all) enum Register {
  SP
  A
  X
  Y
}

pub struct Registers {
  mut sp : @types.UInt8
  mut a : @types.UInt8
  mut x : @types.UInt8
  mut y : @types.UInt8
}
impl Registers {
  new(sp~ : @types.UInt8 = ..) -> Self
  op_get(Self, Register) -> @types.UInt8
  op_set(Self, Register, @types.UInt8) -> Unit
  reset(Self) -> Unit
}

type Trap

// Type aliases

// Traits

